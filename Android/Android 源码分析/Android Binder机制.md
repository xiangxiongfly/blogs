[TOC]

# Android Binder机制

## 概述

- 进程之间是相互隔离的，数据不共享。
- Binder 机制是 Android 操作系统中用于进程间通信（IPC）的一种机制，它允许不同的进程之间相互传递数据和调用方法。Binder 机制是 Android 系统的核心组件之一，广泛应用于各种系统服务和应用程序中。
- 相比传统的IPC通信方式，Binder性能更高、安全性更好、更方便使用。

![在这里插入图片描述](https://img-blog.csdnimg.cn/c54de5491a384b56b852e1f10cddad85.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0ODc2MTMz,size_16,color_FFFFFF,t_70)





## 内存划分

内存被操作系统划分为两块：

- 用户空间：指用户程序代码运行的地方，数据不可共享。
- 内核空间：指内核代码运行的地方，数据可以共享。

为了安全，它们是隔离的，及时用户的程序崩溃了，内核不会受到影响。

在32位系统中，及2^32，共可访问4G内存，内核空间为1G，用户空间为3G。在64位系统中，低位：0～47位才是有效的可变地址（寻址空间256T），高位：48～63位全补0或全补1。一般高位全补0对应的地址空间是用户空间。高位全补1对应的是内核空间。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/06c94a10428f4a219b4a0f4b02dc1e20.png)



## IPC通信方式

### Binder与传统IPC对比

|        | Binder                                   | 共享内存                                 | Scoket                                                  |
| ------ | ---------------------------------------- | ---------------------------------------- | ------------------------------------------------------- |
| 性能   | 一次拷贝                                 | 无需拷贝                                 | 两次拷贝                                                |
| 特点   | 基于C/S架构，易用性高                    | 控制复杂，易用性查                       | 基于C/S架构，作为一款通用接口，其传输效率低，性能开销大 |
| 安全性 | 系统为每个App分配UID，同时支持实名和匿名 | 依赖上层协议，访问接入点是开放的，不安全 | 依赖上层协议，访问接入点是开放的，不安全                |

说明：Binder相比传统IPC方式，具有性能高、安全性好特点。

### 传统IPC传输数据

- 发送端发送数据，通过系统调用 `copy_from_user()` 将数据拷贝到内核空间，第1次拷贝。
- 在通过系统调用 `copy_to_user()` 将数据从内核空间拷贝到接收端，第2次拷贝。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e582476880c24b7bb26d5708f5a103aa.png)

### Binder传输数据

- 传统IPC通行需要拷贝数据2次，而Binder通过mmap内存映射，只需拷贝1次。
- Binder驱动会创建一块接收缓存区，通过mmap实现内存地址映射关系，`mmap()`是操作系统中的一种内存映射方法，简单讲讲用户空间的一块内存区域映射到内核空间，内存映射减少数据拷贝次数。
- 发送端通过系统调用`copy_from_use()`发送数据到虚拟内存区域，由于存在内存映射关系，同时也就发送到接收端的用户空间了。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/47a635c918404dd09036af4bcb031cff.png)