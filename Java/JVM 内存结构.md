@[toc]
# JVM 内存结构

## 概述

JVM虚拟机在运行Java程序是，会管理一块内存区域，即运行时数据区。

在运行时数据区里，会根据用途进行划分：

- JVM栈区
- 本地方法栈
- JVM堆区
- 方法区
- 程序计数器

[官方文档](https://docs.oracle.com/javase/specs/jvms/se8/html/)



## 内存结构图

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210427143444653.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0ODc2MTMz,size_16,color_FFFFFF,t_70)





## JVM栈

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210427160823236.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0ODc2MTMz,size_16,color_FFFFFF,t_70)

### 特点

- 线程私有，随线程生灭
- 每个方法执行时，会在JVM栈中同步创建一个栈帧，即入栈操作，执行完后会出栈

### 作用

- 存放Java方法执行时的局部变量
- 每个栈帧内容包含 ：局部变量表（基本类型，对象引用）、操作数栈、动态连接、方法返回地址

### 异常

- 栈内存不足时会抛出OOM异常即OutOfMemoryError
- 线程请求的栈深度大于JVM规定的深度会抛出StatckOverflowErro异常



## Java堆

### 特点

- JVM堆区是JVM内存中最大的一块，是垃圾回收机制管理的主要区域，也称为GC堆
- 是所有线程共享的
- JVM堆区可以为固定大小，也可以扩展

### 作用

- 存放对象实例、字符串常量池、静态变量、线程分配缓冲区

### 异常

- 当堆内存不足时会抛出OOM异常



## 本地方法栈

- 本地方法栈与JVM虚拟机栈作用类似，虚拟机栈执行Java方法，本地方法栈执行native方法
- 是线程私有的
- 会抛出OOM和StackOverFlowError



## 方法区

### 特点

- Java8采用元空间，在本地内存实现，不受JVM限制

### 作用

- 存放类信息：类的版本、字段、方法、接口和常量池池表
- 运行时常量池：存放类加载后解析的数据，如字面量、符号引用；每个class都有一个运行时常量池，在类解析阶段会将符号引用转换为直接引用

### 异常

- 物理内存占满后会抛出OOM异常



## 程序计数器

程序计数器就是当前线程所执行的字节码的行号指示器，通过改变计数器的值，来选取下一行指令，通过他来实现跳转、循环、恢复线程等功能。

程序计数器是线程私有的，每个线程都已自己的程序计数器。



## 常见问题

### 字面量 符号引用 直接引用

```java
int a = 1; 
String b = "hello"; 

//字面量:数值1和字符串hello 
//符号引用:变量a和变量b
//直接引用:内存地址
```



### 成员变量 局部变量

- 成员变量存放在堆内存中，在类初始化是从运行时常量池（方法区）获取数据，并和初始化对象一起放在堆内存中
- 局部变量存放在JVM栈帧中



### 直接内存

- 常用于NIO操作，数据缓冲区
- 读写性能高，但分配回收成功高
- 不受JVM管理，直接内存位于本地内存，在物理内存耗尽时会报OOM



### JVM内存与本地内存区别

Java虚拟机在执行的时候会把管理的内存分配到不同的区域,这些区域称为虚拟机内存; 同时对于虚拟机没有直接管理的物理内存,也会有一定的利用,这些被利用但不在虚拟机内存的地方称为本地内存.

#### JVM内存

受虚拟机内存大小的参数控制,当大小超过参数设置的大小时会报OOM。

#### 本地内存

本地内存不受虚拟机内存参数的限制,只受物理内存容量的限制; 虽然不受参数的限制,如果所占内存超过物理内存,仍然会报OOM。