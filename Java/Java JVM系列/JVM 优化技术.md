[toc]

# JVM 优化技术

## 概述

JVM常见的优化技术：

- 方法内联优化。
- 栈帧之间数据共享。



## 方法内联优化

### 说明

方法内联（Method Inlining）是JVM的一种优化技术。当一个方法被频繁调用时，JVM会尝试将这个方法的代码直接插入到调用它的地方，以减少方法调用的开销。

### 优点

方法调用在JVM中是有开销的，包括压栈、弹栈、跳转等操作。通过方法内联，可以避免这些开销，从而提高程序的运行效率。

**内联前：**

```java
public class Test {

    public static void main(String[] args) {
        boolean r = max(1, 2);
    }

    private static boolean max(int a, int b) {
        return a > b;
    }
}
```

**内联后：**

```java
public class Test {

    public static void main(String[] args) {
        boolean r = 1 > 2;
    }
}
```

### 内联条件

- 方法的字节码长度：如果一个方法的字节码长度超过一定的阈值（默认是35字节），那么JVM可能不会将其内联。这是因为大的方法可能会使得生成的机器代码过大，从而影响CPU的指令缓存的效率。
- 方法的调用频率：如果一个方法被频繁地调用，那么JVM可能会将其内联，以减少方法调用的开销。
- 方法的复杂性：如果一个方法很复杂（例如，包含了循环或者递归），那么JVM可能不会将其内联。这是因为复杂的方法可能会使得生成的机器代码过大，从而影响CPU的指令缓存的效率。
- 尽量使用private、static、final修饰， 对于被synchronized修饰的方法，HotSpot虚拟机默认不进行内联。



## 栈帧之间数据共享

### 说明

在 JVM 中，栈帧之间的数据是不共享的。每个栈帧都有自己的局部变量表、操作数栈和动态链接等信息。当一个方法被调用时，JVM 会创建一个新的栈帧并将其压入栈顶。当方法执行结束后，其对应的栈帧会被弹出，这个过程中不会影响到其他的栈帧。

但在一些特定的条件下，可以实现栈帧之间的数据共享。

### 优点

- 节约内存。
- 无需参数复制提高执行效率。

### 栈帧之间数据共享条件

JVM栈帧之间的数据共享主要通过方法调用的参数传递和返回值实现：

- 方法调用：当一个方法调用另一个方法时，可以通过参数传递的方式在栈帧之间共享数据。被调用的方法可以访问到调用方法传递的参数。
- 对象引用：如果一个方法创建了一个对象，并将这个对象的引用传递给了另一个方法，那么这两个方法就可以共享这个对象的数据。这是因为它们共享的是同一个对象的引用。
- 静态变量：静态变量存储在堆中，而不是栈中。所有的栈帧都可以访问到同一个类的静态变量，因此可以通过静态变量在栈帧之间共享数据。

